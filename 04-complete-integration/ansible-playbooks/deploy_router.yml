---
- name: Deploy Virtual Router with Firewall (PING OK, HTTP BLOCKED)
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    router_name: "{{ router_id | default('vrouter-connectivity-001') }}"
    router_image: "frrouting/frr:latest"
    
  tasks:
    - name: "Remove existing router container"
      shell: "docker rm -f {{ router_name }}"
      ignore_errors: true
      
    - name: "Pull router image"
      shell: "docker pull {{ router_image }}"
      
    - name: "Deploy router container with firewall"
      shell: >
        docker run -d
        --name {{ router_name }}
        --privileged
        --cap-add=NET_ADMIN
        --sysctl net.ipv4.ip_forward=1
        {{ router_image }}
        sh -c "
        /usr/lib/frr/frrinit.sh start &&
        echo 'Configurando firewall - PING OK, HTTP BLOQUEADO' &&
        iptables -F &&
        iptables -P FORWARD ACCEPT &&
        iptables -A FORWARD -p icmp -j ACCEPT &&
        iptables -A FORWARD -p tcp --dport 80 -j DROP &&
        echo 'Firewall configurado: ICMP permitido, HTTP bloqueado' &&
        tail -f /dev/null
        "
      register: container_result
      
    - name: "Wait for router to be ready"
      wait_for:
        timeout: 10
        
    - name: "Connect router to client network (192.168.100.0/24)"
      shell: "docker network connect 04-complete-integration_client_net {{ router_name }}"
      register: client_net_result
      failed_when: false
      
    - name: "Connect router to server network (192.168.200.0/24)"
      shell: "docker network connect 04-complete-integration_server_net {{ router_name }}"
      register: server_net_result
      failed_when: false
      
    - name: "Wait for network configuration"
      wait_for:
        timeout: 5
        
    - name: "Verify firewall rules"
      shell: "docker exec {{ router_name }} iptables -L FORWARD -n"
      register: firewall_check
      
    - name: "Display deployment results"
      debug:
        msg:
          - "=== ROUTER + FIREWALL DEPLOYMENT SUCCESSFUL ==="
          - "Router: {{ router_name }}"
          - "Connected to client network: {{ 'OK' if client_net_result.rc == 0 else 'FAIL' }}"
          - "Connected to server network: {{ 'OK' if server_net_result.rc == 0 else 'FAIL' }}"
          - "Firewall Status: PING permitido, HTTP BLOQUEADO"
          - "Status: ROUTER READY - Airflow necesario para habilitar HTTP"